# 리팩토링이란?

프로그램이 새로운 기능을 추가하기에 편한 구조가 아니라면, 먼저 기능을 추가하기 쉬운 형태로 리팩터링하고 나서 원하는 기능을 추가한다.

## 1. 리팩토링 할 곳 찾아보기

statement 함수는 기능이 많지 않은 함수지만 기능이 추가가 되면 복잡도가 증가한다.
연극 장르와 공연료 정책이 달라질 때마다 statement 함수를 수정해야 하는 이슈도 있다.
만약 청구 내역을 HTML로 출력하는 함수를 생각 없이 분리 시킨다면, 변동사항이 생길 때마다 두 함수를 모두 수정해야 한다.

정책이 복잡해지면 실수한 가능성이 높아진다.
리팩토링도 무작정 함수를 나눈다고 좋은 퍼포먼스를 낼 수 있는게 아니다.

## 2. 테스트 코드가 있으면 리팩토링이 수월하다

리팩토링을 하기 전에 제대로 된 테스트부터 마련한다. 테스트는 반드시 자가진단하도록 만든다.
프로그램이 클 수록 예상하지 못한 곳에서 오류가 발생할 가능성이 커진다.
statement 함수의 같은 경우는 문자열을 반환하므로, 다양한 장르의 공연들로 구성된 데이터를 준비해서 테스트를 하면 된다.


## 3. statement() 함수 쪼개기

statement() 처럼 긴 함수를 리팩토링할 때는 먼저 전체 동작을 각각의 부분으로 나눌 수 있는 지점을 찾는다.
그러면 중간 즈음의 switch문이 눈에 띈다.

`switch 문은 한 번의 공연에 대한 요금을 계산하고 있다. 이런 사실은 코드를 분석해서 얻은 정보다. 이런 식으로 파악한 정보는 휘발성이 높기로 악명 높은 저장 장치인 내 머릿속에 기록되므로, 잊지 않으려면 재빨리 코드에 반영해야 한다!!`

코드가 하는일을 설명하는 이름을 지어준다. amountFor(aPerformance) 정도로


```javascript
function amounFor(perf, play) {
  let thisAmount = 0;
  switch (play.type) {
    case 'tragedy':
      thisAmount = 40000;
      if (perf.audience > 30) {
        thisAmount += 1000 * (perf.audience - 30);
      }
      break;
    case 'comedy':
      thisAmount = 30000;
      if (perf.audience > 20) {
        thisAmount += 10000 + 500 * (perf.audience - 20);
      }
      thisAmount += 300 * perf.audience
      break;
    default:
      throw new Error(`알 수 없는 장르 : ${play.type}`);
  }
  return thisAmount;
}
```

### 위의 함수를 적용시켜 본다

```javascript
function statement(invoice, plays) {
  let totalAmount = 0;
  let volumeCredits = 0;
  let result = `청구 내역 (고객명: ${invoice.customer})\n`;
  const format = new Intl.NumberFormat('en-US', {
    style: 'currency', currency: 'USD', minimumFractionDigits: 2,
  }).format;

  for (let perf of invoice.performances) {
    const play = plays[perf.playID];
    let thisAmount = amountFor(perf, play);
    volumeCredits += Math.max(perf.audience - 30, 0);
    if ('comedy' === play.type) volumeCredits += Math.floor(perf.audience / 5);

    result += ` ${play.name}: ${format(thisAmount/100)} (${perf.audience}석)\n`;
    totalAmount += thisAmount;
  }

  result += `총액: ${format(totalAmount/100)}\n`;
  result += `적립 포인트: ${volumeCredits}점\n`;
  return result;
}
```

